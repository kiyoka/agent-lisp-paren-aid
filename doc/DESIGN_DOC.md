This document is written in Japanese, because my native language is Japanese...

# コーディングエージェント向けLisp支援ツール

## はじめに

OpenAIのo3やGoogleのgemini-2.5-proといった2025年時点のLLMは、Lispコードを生成する際に閉じ括弧を正しく記述できない場合があります。
生成されたコードに間違いがあった場合、コーディングエージェントが自力で修正するのは困難です。
このツールは、Lispコードの括弧の対応をチェックし、エージェントによる修正を支援することを目的としています。

- 参考ブログ記事
  https://zenn.dev/kiyoka/articles/coding-agent-1

この問題は、将来的にはLLMの性能向上によって解決される可能性があるため、本ツールはそれまでの一時的なソリューションとなることを想定しています。

## ユースケース

コーディングエージェントがLispコードを生成・編集した後に、本ツールを利用して構文チェックを行います。

1.  **括弧に問題がない場合**
    ツールは何も出力しません。エージェントは特別な対応をする必要はありません。
2.  **括弧が多すぎる場合**
    ツールは、問題のある行番号を提示します。
3.  **括弧が少なすぎる場合**
    ツールは、問題のある行番号を提示します。
    その情報に基づいてエージェントがソースコードを修正する想定のツールです。

このツールをエージェントのワークフローに組み込む際は、`GEMINI.md`などにツールの使用方法を記載することを推奨します。

## 開発言語

- TypeScript

## 補助ツール

- emacs

## 配布形態

以下の形式で配布します。

- Denoを利用したシングルバイナリ

## インターフェース

- コマンドライン

```bash
  agent-lisp-paren-aid [ファイル名]
```

- 診断結果

標準出力に結果を出力する

  - エラーなしの場合
  
  ```
  ok
  ```
  
  - 括弧の記号が合っていない場合。もし2件以上の不整合があったとしても、ファイルの先頭から最初に見つかった1件だけしか検出・報告しない
  
  ```
  error
  
  Line 10: There are extra 2 closing parentheses.
  ```

## 仕様

- スペースは1文字のインデントとしてカウントする。
- タブ文字は8文字のスペースと同じインデント幅としてカウントする。
- 括弧の不整合の検出
  - ファイルの最後まで到達した時、括弧のカウンターが丁度ゼロにならなかった
    その場合、(DB1) の記録に対して (L1) の1行前から上向きに検索し、最初に見つかった ')' を括弧の付け忘れ、もしくは付けすぎと判断する
  - ファイル全体で括弧の開閉数が一致していても、途中で括弧の対応が崩れている場合がある (issue 10)
    この場合も括弧の不整合として検出する必要がある
- 括弧の不整合を検出した場合、TypeScriptで書いたパーサーではどこが漏れているかを計算せず、以下の方法で問題の箇所を特定する。
  - 引数で指定されたファイルを /tmp/ にコピーし、emacsのindent-regionを使ってインデントし直す。
  - 引数に渡されたlispファイルと先程emacsでインデントしたファイルの差分を取って、最初に差分が出た行番号を括弧の過不足の行番号とする。
    - 差分を取ってインデントが深くなった場合は、括弧が不足とみなす
    - 差分を取ってインデントが浅くなった場合は、括弧が過剰とみなす
- 括弧の総数が一致している場合でも、Emacsでインデントした結果と差分がある場合は不整合として検出する
  - これにより、途中で括弧の対応が崩れているケースも検出可能になる

## パーサーの処理内容

- 概要
  - コマンドライン引数で渡されたファイルをLispファイルとしてTypeScriptでパースする。

- パース処理
  - トークナイザー
    - コメント文を無視する(Emacs Lispのコメント表記)
    - 文字列リテラルを読み飛ばす
    - '(' トークンが見つかったら、括弧のカウンターを増やす
    - ')' トークンが見つかったら、括弧のカウンターを減らす
    - 出現した全ての ')' トークンを行番号とともに記録する (DB1)
	- それ以外の文字列の連続はその他のトークンの塊として読み飛ばす
