This document is written in Japanese, because my native language is Japanese...

# コーディングエージェント向けLisp支援ツール

## はじめに

OpenAIのo3やGoogleのgemini-2.5-proといった2025年時点のLLMは、Lispコードを生成する際に閉じ括弧を正しく記述できない場合があります。
生成されたコードに間違いがあった場合、コーディングエージェントが自力で修正するのは困難です。
このツールは、Lispコードの括弧の対応をチェックし、エージェントによる修正を支援することを目的としています。

- 参考ブログ記事
  https://zenn.dev/kiyoka/articles/coding-agent-1

この問題は、将来的にはLLMの性能向上によって解決される可能性があるため、本ツールはそれまでの一時的なソリューションとなることを想定しています。

## ユースケース

コーディングエージェントがLispコードを生成・編集した後に、本ツールを利用して構文チェックを行います。

1.  **括弧に問題がない場合**
    ツールは何も出力しません。エージェントは特別な対応をする必要はありません。
2.  **括弧に問題がある場合**
    ツールは、問題のある行番号と、不足している閉じ括弧の個数を提示します。
    エージェントは、その情報に基づいてソースコードを修正します。

このツールをエージェントのワークフローに組み込む際は、`GEMINI.md`などにツールの使用方法を記載することを推奨します。

## 開発言語

- TypeScript (予定)

## 配布形態

以下のいずれかの形式で配布します。

1.  npmパッケージ
2.  Denoを利用したシングルバイナリ

## インターフェース

- コマンドライン

```bash
  agent-lisp-paren-aid [ファイル名]
```

- 診断結果

標準出力に結果を出力する

  - エラーなしの場合
  
  ```
  ok
  ```
  
  - 括弧の記号が合っていない場合。もし2件以上の不整合があったとしても、最初の1個だけしか検出・報告しない
  
  ```
  error
  
  Line 10: There are 2 closing parentheses.
  ```

## 仕様

- スペースは1文字のインデントとしてカウントする。
- タブ文字は8文字のスペースと同じインデント幅としてカウントする。

## 処理内容

- 概要
  - コマンドライン引数で渡されたファイルをLispファイルとしてパースする。

- パース処理
  - トークナイザー
    - コメント文を無視する(Emacs Lispのコメント表記)
    - 文字列リテラルを読み飛ばす
    - '(' を開き括弧とする
    - ')' を開き括弧とする
	- それ以外の文字列の連続はその他のトークンの塊として読み飛ばす

- インデントの深さの記録
  - '(' トークンが見つかったら行番号と行頭からのインデント幅のペア情報を1件としてスタックに積む
    - このインデント幅をカレントのインデント幅として覚えておく(A)
  - ')「トークンが見つかったらスタックから1件削除する
    - 1件削除したデータはエラー報告用として覚えておく(B)

- 閉じ括弧のチェックロジック

開き括弧のトークンを検出した際、カレントのインデント幅とソースコードの実際のインデント幅が異なる場合、括弧の対応がおかしいと見做しエラーとする
エラーの報告内容としては、以下の2つの可能性を提示し、エラー箇所の判断は、利用者に任せるという旨のメッセージも表示する
1. 前述の(B)の行で閉じ括弧が少ない
2. (A)から(B)までの間のどこかに閉じ括弧が入っていない
